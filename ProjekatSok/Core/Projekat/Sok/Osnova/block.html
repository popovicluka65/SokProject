<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .links line {
    stroke: #999;
    stroke-opacity: 0.6;
    stroke-width: 5px;
  }

  .nodes foreignObject {
    pointer-events: all;
  }
</style>

<svg width="1800" height="800"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
  var svg = d3.select("svg");
  var width = svg.attr("width");
  var height = svg.attr("height");

  var graph = {
    nodes: [

        { id: 1, value: {"@id": "28dddab1-4aa7-6e2b-b0b2-7ed9096aa9bc", "name": "I\u0027m parent"} },

        { id: 2, value: {"@id": "6616c598-0a0a-8263-7a56-fb0c0e16225a", "name": "I\u0027m first child"} },

        { id: 3, value: {"@id": "940e60e4-9497-7c0d-3467-2dawdaw2", "name": "I\u0027m second child"} },

    ],
    links: [

        { source: 1, target: 2 },

        { source: 1, target: 3 },

        { source: 2, target: 1 },

        { source: 3, target: 1 },

    ]
  };

  var linkGroup = svg.append("g").attr("class", "links");
  var nodeGroup = svg.append("g").attr("class", "nodes");

  var simulation = d3
  .forceSimulation(graph.nodes)
  .force(
    "link",
    d3.forceLink()
      .id(function (d) {
        return d.id;
      })
      .links(graph.links)
      .distance(300)
  )
  .force("charge", d3.forceManyBody().strength(-30))
  .force("center", d3.forceCenter(width / 2, height / 2))
  .force("collision", d3.forceCollide().radius(function (d) {
    return d.radius || 100; // You can adjust the radius as needed
  }))
  .on("tick", ticked);

var nodes = nodeGroup
  .selectAll("foreignObject")
  .data(graph.nodes)
  .enter()
  .append("foreignObject")
  .attr("x", function (d) {
    return d.x - calculateWidth(d) / 2;
  })
  .attr("y", function (d) {
    return d.y - calculateHeight(d) / 2;
  })
  .attr("width", function (d) {
    return calculateWidth(d);
  })
  .attr("height", function (d) {
    return calculateHeight(d);
  })
  .html(function (d) {
  return `<div style=" width:100%; height:100%; background-color:white; border: 2px solid red; box-sizing: border-box; border-radius:5px; display:flex; flex-direction:column; justify-content:center;">
    <div style="border-bottom: 2px solid red; font-family:Arial; font-weight:bold; display:flex; justify-content:center;">${d.id}</div>
    ${Object.entries(d.value)
    .map(([key, val]) => `<div style="margin-left:10px; font-family:Arial;">${key}: ${val}</div>`)
    .join('')}</div>`;
})
  .call(
    d3
      .drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended)
  );

function calculateWidth(d) {
  var widthFactor = 10;
  var textContent = Object.entries(d.value)
    .map(([key, val]) => `${key}: ${val}`)
    .join('\n');

  var textWidth = getTextWidth(textContent, '14px Arial');
  return Math.min(textWidth + 20, widthFactor * 20);
}

function calculateHeight(d) {
  var textContent = Object.entries(d.value)
    .map(([key, val]) => `${key}: ${val}`)
    .join('\n');

  var textLines = textContent.split('\n').length;
  return textLines * 20 + 20;
}

function getTextWidth(text, font) {
  var canvas = document.createElement('canvas');
  var context = canvas.getContext('2d');
  context.font = font;
  var width = context.measureText(text).width;
  return width;
}

  var links = linkGroup
    .selectAll("line")
    .data(graph.links)
    .enter()
    .append("line")
    .attr("class", "link");

  function ticked() {
    nodes
      .attr("x", function (d) {
        return d.x - 40;
      })
      .attr("y", function (d) {
        return d.y - 20;
      });

    links
      .attr("x1", function (d) {
        return d.source.x;
      })
      .attr("y1", function (d) {
        return d.source.y;
      })
      .attr("x2", function (d) {
        return d.target.x;
      })
      .attr("y2", function (d) {
        return d.target.y;
      });
  }

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
</script>